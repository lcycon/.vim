<?php

$date1 = $_GET['from'];
$date2 = $_GET['to'];
$number = $_GET['num'];

$date1 .= "%2000:00:00";
$date2 .= "%2023:59:59";

$url = "http://mjadmin.herokuapp.com/api/photos/date_range?start={$date1}&end={$date2}";

$query = url_get_contents($url);
$query = json_decode($query, true);


if(count($query['photos']) == 0){
    die("An error occured");
}

foreach($query['photos'] as $key => $result){
    $photourl = 'http://marcfam.marcjacobs.com/' . base64_encode($result['id']);
    $url = "http://graph.facebook.com/fql?q=" . rawurlencode("SELECT total_count from link_stat where url=\"{$photourl}\""); 
    $data = url_get_contents($url); 
    $temp = json_decode($data, true);
    $query['photos'][$key]['likes'] = $temp['data'][0]['total_count'];
}

$sort = array();
foreach($query['photos'] as $key => $value){
    $sort[$key] = $value['likes'];
}

array_multisort($sort, SORT_DESC, $query['photos']);
ovar_dump($query);

$str = "";
$num = 0;
foreach($query['photos'] as $key => $value){
    if($num >= $number){
        break;
    }
    $num++;
    $str .= "<div class=\"row\"><div class=\"user\">{$value['user']}</div><div class=\"url\">" . 'http://marcfam.marcjacobs.com/' . base64_encode($value['id']) . "</div>";
    $str .= "<div class=\"likes\">Likes: {$value['likes']}</div><br />";
}

echo $str;

function url_get_contents($url,$useragent='cURL',$headers=false, $follow_redirects=false,$debug=false) {

    # initialise the CURL library
    $ch = curl_init();

    # specify the URL to be retrieved
    curl_setopt($ch, CURLOPT_URL,$url);

    # we want to get the contents of the URL and store it in a variable
    curl_setopt($ch, CURLOPT_RETURNTRANSFER,1);

    # specify the useragent: this is a required courtesy to site owners
    curl_setopt($ch, CURLOPT_USERAGENT, $useragent);

    # ignore SSL errors
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);

    # return headers as requested
    if ($headers==true){
        curl_setopt($ch, CURLOPT_HEADER,1);
    }

    # only return headers
    if ($headers=='headers only') {
        curl_setopt($ch, CURLOPT_NOBODY ,1);
    }

    # follow redirects - note this is disabled by default in most PHP 
    # installs from 4.4.4 up
    if ($follow_redirects==true) {
        curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);
    }

    # if debugging, return an array with CURL's debug info and the URL 
    # contents
    if ($debug==true) {
        $result['contents']=curl_exec($ch);
        $result['info']=curl_getinfo($ch);
    }

    # otherwise just return the contents as a variable
    else $result=curl_exec($ch);

    # free resources
    curl_close($ch);

    # send back the data
    return $result;
}
